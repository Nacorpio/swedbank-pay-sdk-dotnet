name: Build


on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-20.04

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.101

    - name: Install dependencies
      run: dotnet restore ./src/SwedbankPay.Sdk.sln

    - name: Build SDK
      run: dotnet build --configuration Release --no-restore src/SwedbankPay.Sdk/SwedbankPay.Sdk.csproj

    - name: Build SDK Tests
      run: dotnet build --configuration Release --no-restore src/SwedbankPay.Sdk.Tests/SwedbankPay.Sdk.Tests.csproj

    - name: Run SDK Tests
      run: dotnet test --configuration Release src/SwedbankPay.Sdk.Tests/SwedbankPay.Sdk.Tests.csproj
      env:
        SwedbankPay:Token: ${{ secrets.MERCHANT_TOKEN }}
        SwedbankPay:PayeeId: ${{ secrets.MERCHANT_PAYEEID }}
    
    - name: Build SDK Sample project
      run: dotnet build --configuration Release --no-restore src/Samples/Sample.AspNetCore/Sample.AspNetCore.csproj

    - name: Start SDK Sample project
      run: dotnet run --configuration Release -p src/Samples/Sample.AspNetCore/Sample.AspNetCore.csproj &
      env:
        SwedbankPay:Token: ${{ secrets.MERCHANT_TOKEN }}
        SwedbankPay:PayeeId: ${{ secrets.MERCHANT_PAYEEID }}

    - name: Build SDK Sample test project
      run: dotnet build --configuration Release --no-restore src/Samples/Sample.AspNetCore.SystemTests/Sample.AspNetCore.SystemTests.csproj

    - name: Run SDK Sample project tests
      run: dotnet test --configuration Release src/Samples/Sample.AspNetCore.SystemTests/Sample.AspNetCore.SystemTests.csproj
      env:
        SwedbankPay:Token: ${{ secrets.MERCHANT_TOKEN }}
        SwedbankPay:PayeeId: ${{ secrets.MERCHANT_PAYEEID }}
        SwedbankPay:ApiBaseUrl: https://api.externalintegration.payex.com
        Swedbank:Pay:Sdk:SampleWebsite:BaseUrl: https://localhost:44344

    - name: Install GitVersion
      uses: gittools/actions/gitversion/setup@v0.9.3
      with:
          versionSpec: '5.3.x'

    - name: Fetch all history for all tags and branches
      run: git fetch --prune --unshallow

    - name: GitVersion

      id: gitversion # step id used as reference for output values
      uses: gittools/actions/gitversion/execute@v0.9.3

    - name: Publish to NuGet
      env:
        PROJECT_FILE: src/SwedbankPay.Sdk/SwedbankPay.Sdk.csproj
        VERSION_NUMBER: ${{ steps.gitversion.outputs.nuGetVersionV2 }}
        NUGET_KEY: ${{ secrets.NUGET_KEY}}
      run: .github/workflows/nuget_push.sh
